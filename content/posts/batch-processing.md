---
title: "バッチ処理"
date: 2021-02-15T05:46:29+09:00
tags: ["勉強ノート", "分散システム"]
---

## 前提知識

- [データベースシステム]({{< ref "database-system" >}})
- [分散システム]({{< ref "distributed-system" >}})

---

バッチ処理とは、ひとまとまりのデータを一括して処理する方式である。

## 利用用途

- DWH から取得したデータを ETL (Extract/Transform/Load, 抽出/変換・加工/ロード) に通して集計する。
- 複数の画像ファイルに対してリサイズや変換, クレジット表記などの編集操作を一括で行う。
- ファイル形式を変換する。

## 利点

- 処理のタイミングをリソースがあまり忙しくないの時間帯 (ex. 深夜) にシフトできる。

## ラムダアーキテクチャ

ラムダアーキテクチャ (lambda architecture) は、ストリーム処理とバッチ処理の利点を両立しつつ、膨大な量のデータを処理するためのアーキテクチャである。

<!-- TODO ラムダアーキテクチャのダイアグラムを載せる -->

### バッチレイヤー

バッチレイヤー (batch layer) は分散処理を用いて膨大な量のデータを処理する。
バッチレイヤーはすべてのデータを処理して完全で正確なビューを作成することに特化している。

ビューに含まれる不完全もしくは不正確なデータは、バッチレイヤーが完全なデータから再計算したビューを上書きすることによって修正される。

### スピードレイヤー

スピードレイヤー (speed layer) はリアルタイムにデータを処理し、最新のデータから**リアルタイムビュー**を作成する。
スピードレイヤーは、スループットを犠牲にしてレイテンシを最小化することに特化している。

リアルタイムビューは不完全で不正確なものでもよい。
それらは前述のバッチレイヤーの処理によって結果的に解消される。

スピードレイヤーは必然的に、バッチレイヤーのレイテンシが引き起こすデータのラグを埋める責務をもつ。

### サービングレイヤー

サービングレイヤー (serving layer) は、バッチレイヤーやスピードレイヤーによって作られたビューを用いて、アドホックなクエリに応答する。

## Hadoop

Hadop は多くのノードを含むネットワークと分散ファイルシステムを管理し、膨大な量のデータを処理するためのソフトウェアフレームワークである。

Hadoop は下記に示すコンポーネントから構成される。

### 分散ファイルシステム

#### HDFS

HDFS (Hadoop Distributed File System) は Hadoop 標準の分散ファイルシステムである。

HDFS は 下記のような特徴をもつ。

- **プライマリ/バックアップ型**
  - ファイルとブロックの対応関係を管理する **NameNode** (プライマリ)
  - 実データのブロックを保持する **DataNode** (バックアップ)
- レプリケーション機能 (標準のレプリケーション数は 3)

### リソースマネージャ

リソースマネージャは、計算リソースの管理やジョブのスケジューリングを行う。

Hadoop 標準のリソースマネージャは **YARN (Yet Another Resource Negotiator)** である。

### 処理エンジン

#### MapReduce

MapReduce は Hadoop 標準の処理エンジンである。

1. プライマリノードは、入力データを細かい単位に分割し、複数のバックアップノードに割り当て (map) る。
1. バックアップノードは、受け取った入力データの分割を処理し、処理結果をプライマリに返す。
1. プライマリノードは、バックアップノードから受け取った処理結果を何らかの方法で集約 (reduce) する。

上記のバックアップノードでの処理は完全に独立しており、理論的には並列実行できる。

また、一部のバックアップノードで障害が発生した場合においても、入力データが利用可能である限りは処理を再スケジュールして実行させることができる。

#### Spark

Spark は、RDD (resilient distributed dataset) という分散された読み込み専用の入力データを中心とするプログラミングインターフェイスを提供する。

Spark は、MapReduce で map/reduce に分解できない、ループ内で複数回データセットを参照するような対話的/探索的データ処理に向いている。

## 参考文献

- 西田 圭介, ビッグデータを支える技術, 2017
- Wikipedia, [Lambda architecture](https://en.wikipedia.org/wiki/Lambda_architecture)
- Wikipedia, [Apache Hadoop](https://ja.wikipedia.org/wiki/Apache_Hadoop)
- Wikipedia, [MapReduce](https://ja.wikipedia.org/wiki/MapReduce)
- Wikipedia, [Apache Spark](https://en.wikipedia.org/wiki/Apache_Spark)
