---
title: "データベースシステム"
date: 2021-01-07T02:48:10+09:00
tags: ["勉強ノート", "データベース"]
---

## データベースのアーキテクチャ

### in-place 更新型アーキテクチャ

in-place 更新型アーキテクチャを採用する DBMS に MySQL がある。

### 追記型アーキテクチャ

追記型アーキテクチャを採用する代表的なデータベースに PostgreSQL がある。

追記型アーキテクチャを採用するデータベースでは内部的に in-place な更新を行えない。
よって、追記型アーキテクチャでは、実際のレコードを削除する代わりに該当行に削除マークを付ける**論理削除**を行う。

> データを削除する際は実際のレコードは削除せず、該当行に削除マークを付けるのみである。
> 更新の際も内部的には削除と挿入を同時に行っている。

論理削除は、不要になった領域 (削除マークが付いたレコードの領域) を定期的に回収し、再利用可能な状態に変更する処理を必要とする。
PostgreSQL のバキューム (VACUUM), Cassandra のコンパクション (compaction) が該当する。

> 更新・削除が繰り返されるテーブルにおいては、たとえ理論的な行数が変わらなくとも、更新・運用を重ねるごとに物理的なファイルサイズが増加する。
> (中略)
> VACUUM は、単に領域を回収し、そこを再利用可能な状態に変更します。

## ACID 原則

データベースシステムは全てのトランザクションが ACID 原則に従うことを要求する。

原子性 (Atomicity)
: トランザクションに含まれるタスクが全て実行されるか、あるいは全く実行されないことを保証する性質。

一貫性 (Consistency)
: トランザクション開始と終了時にあらかじめ与えられた整合性を満たすことを保証する性質。

独立性 (Isolation)
: トランザクション中に行われる操作の過程が他の操作から隠蔽される性質。

永続性 (Durability)
: 独立性と性能はトレードオフの関係にあるため、一般的なデータベースシステムはこの性質の一部を緩和して実装される場合が多い。 (後述の MVCC 参照)

### 可用性の向上

基本的には独立性を犠牲し、複数のトランザクションを並行に実行する。この時のトランザクションの独立性は後述のトランザクション分離レベルを参照。

MVCC (MultiVersion Concurrency Control, 多版型同時実行制御)
: MVCC は**並行性制御**の 1 つである。
MVCC では書き込み処理が行われている最中に他のトランザクションによる読み取りアクセスがあった場合、書き込みの直前の状態 (= スナップショット) を処理結果として返す。
つまり、書き込み中も読み取りができ、読み取り中でも書き込みができる。

<!-- TODO Lost update について書く -->
<!-- TODO SELECT ... FOR UPDATE について書く -->

### 独立性の保証

独立性を提供する主な手段は並行性制御となる。

悲観的ロック
: トランザクションの開始から完了まで他からの更新を抑止する。

デッドロック
: 悲観ロックを採用した場合に発生しうる、2 つ以上のトランザクションが互いのロック解除を待ち、互いの進行を妨げてしまう現象。
デッドロックを防ぐには、ロックの順番を同じにする。

楽観的ロック
: 上記の悲観ロックとは対照的に存在する並行性制御。

> 他の処理と競合してはならないトランザクションにおいて、開始時には特に排他処理など行なわず、完了する際に他からの更新がされたか否かを確認し、もし他から更新されてしまっていたら自らの更新処理を破棄し、エラーとする。

**時刻印ロック**は完了する際に他からの更新がされたか否かを確認する方法の 1 つである。

### 原子性と永続性の保証

ロールバック
: トランザクションがコミットできなかった場合に、事前に取っておいたデータベース情報のコピー (before image) を使って、データベースをトランザクション開始前の状態に戻すこと。

ロールフォワード
: データベースに障害が発生した場合に、コミットログと同じコミットを適用してデータベースを最新状態にすること。
バックアップはバックアップ取得後にコミットされたトランザクションによる更新を反映していないが、バックアップから復元した後にロールフォワードすることで、障害発生直前までにコミットした全トランザクションが反映された状態まで復旧できる。

<!-- TODO フルバックアップの取得間隔とロールフォワードの所要時間の関係について書く -->

WAL (= Write Ahead Log, ログ先行書き込み)
: コミットログを最初に書き込むので、クエリを処理している間に障害が起こった場合、ロールフォワードでコミットされる。
主に in-place な更新できるデータベースで採用されている。

シャドウページング
: あるページに変更を加える際に、まずシャドウページがアロケートされる。
ページの変更が完了し永続化可能な状態になったら、変更前のページを参照している箇所全てを新しいページを参照するように変更する。
主に in-place な更新を行えないデータベースで採用されている。

## トランザクション分離レベル

トランザクション分離レベルとは、トランザクションが複数同時に行われた場合、どれほどの一貫性、正確性で実行するかを 4 段階で定義したものである。
ACID 原則のうちの I に関わる概念である。

ダーティリード
: 不完全なデータや、計算途中のデータを読み取ってしまう動作。

ノンリピータブルリード
: 同じトランザクション中でも同じデータを読み込むたびに値が変わってしまう現象。

ファントムリード
: 並行して動作する他のトランザクションが追加したり削除したデータが途中で見えてしまう現象。

| レベル           | 説明                                                                                                      | ファントムリードの発生 | ノンリピータブルリードの発生 | ダーティリードの発生 | デフォルトにしている DBMS |
| :--------------- | :-------------------------------------------------------------------------------------------------------- | :--------------------- | :--------------------------- | :------------------- | :------------------------ |
| READ UNCOMMITTED | 確定していないデータまで読み取る                                                                          | Yes                    | Yes                          | Yes                  |                           |
| READ COMMITTED   | 確定した最新データを常に読み取る (前述の MVCC は READ COMMITTED に該当する処理である)                     | Yes                    | Yes                          | No                   | PostgreSQL, Oracle        |
| REPEATABLE READ  | 読み取り対象のデータを常に読み取る                                                                        | Yes                    | No                           | No                   | MySQL                     |
| SERIALIZABLE     | 直列化可能 (いかなる場合でも、それらのトランザクションを時間的重なりなく逐次実行した場合と同じ結果になる) | No                     | No                           | No                   |                           |

- MySQL + InnoDB のデフォルトでは REPEATABLE READ で動作するが、**ネクストキーロック**, **ギャップロック**という仕組みでファントムリードを回避する。
  (cf. [InnoDB Locking](https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html))

<!-- TODO ビュー, 実体ビュー について書く -->

<!-- TODO インデックス (B-tree, ハッシュ) について書く -->

<!-- TODO テーブル結合について書く -->

<!-- TODO パーティション (シャード) について書く -->

## 参考文献

- Oracle Corporation, [MySQL 8.0 Reference Manual](https://dev.mysql.com/doc/refman/8.0/en/), 2020
- PostgreSQL グローバル開発グループ, [PostgreSQL 12.4 文書](https://www.postgresql.jp/document/12/html/), 2020
- Wikipedia, [ACID](<https://ja.wikipedia.org/wiki/ACID_(%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF%E7%A7%91%E5%AD%A6)>)
- Wikipedia, [MultiVersion Currency Control](https://ja.wikipedia.org/wiki/MultiVersion_Concurrency_Control)
- Wikipedia, [並行性制御](https://ja.wikipedia.org/wiki/%E4%B8%A6%E8%A1%8C%E6%80%A7%E5%88%B6%E5%BE%A1)
- Wikipedia, [悲観的並行性制御](https://ja.wikipedia.org/wiki/%E6%82%B2%E8%A6%B3%E7%9A%84%E4%B8%A6%E8%A1%8C%E6%80%A7%E5%88%B6%E5%BE%A1)
- Wikipedia, [楽観的並行性制御](https://ja.wikipedia.org/wiki/%E6%A5%BD%E8%A6%B3%E7%9A%84%E4%B8%A6%E8%A1%8C%E6%80%A7%E5%88%B6%E5%BE%A1)
- Wikipedia, [ログ先行書き込み](https://ja.wikipedia.org/wiki/%E3%83%AD%E3%82%B0%E5%85%88%E8%A1%8C%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF)
- Wikipedia, [シャドウページング](https://ja.wikipedia.org/wiki/%E3%82%B7%E3%83%A3%E3%83%89%E3%82%A6%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%B3%E3%82%B0)
- Wikipedia, [トランザクション分離レベル](https://ja.wikipedia.org/wiki/%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E5%88%86%E9%9B%A2%E3%83%AC%E3%83%99%E3%83%AB)
- saiya_moebius, [RDBMS in Action](https://speakerdeck.com/saiya_moebius/rdbms-in-action), 2019
