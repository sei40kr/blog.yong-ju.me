---
title: "分散システム"
date: 2021-01-10T04:54:24+09:00
tags: ["勉強ノート", "分散システム", "データベース"]
---

## 前提知識

- [データベースシステム]({{< ref "database-system" >}})

## グロッシュの法則

> コンピュータの性能は価格の 2 乗に比例する

グロッシュの法則は 1980 年代以降のコンピュータに対して成り立たなくなってきた。

それに伴い、システムのスループットを向上させるために、より優れたハードウェアを導入する方法 (**スケールアップ, scale-up**) より安価なハードウェアの台数を増やす方法 (**スケールアウト, scale-out**) がコスト面で有利であると考えられるようになった。

## 分散システムの原則

分散システムは以下の原則を満たすことを期待する。

1. 分散が透過的であること
   - **位置に対する透過性**
   - **複製 (レプリケーション) に対する透過性**
   - **分割に対する透過性**
1. トランザクションが透過的であること

「透過的である」とは、ユーザー (ex. 分散データベースの場合はアプリケーション開発者) がそのシステムの技術的詳細を意識することなく使えることを意味する。

## 分散システムの落とし穴

- ネットワークは信頼できない。
- レイテンシはゼロではない。
- 帯域幅が存在する。
- トランスポートコストはゼロではない。

## アムダールの法則

**アムダールの法則**は、並列コンピューティングにおいて、並列度を上げた場合に並列化できない部分の存在がボトルネックになることを示すものである。
分散システム全体のスループットにおいても、ノード数を並列度として同じように考えることができる。

$P$
: プログラムの並列化できる部分の実行時間の割合

$N$
: 使用するプロセッサの個数 (分散システムではノード数)

としたとき、並列化による全体の性能向上率は次の式で表される。

$$=\frac{1}{(1-P)+\frac{P}{N}}$$

## CAP 定理

ノード間のデータ複製において、同時に次の 3 つの保証を提供できない。

一貫性 (Consistency)
: すべてのデータ読み込みにおいて、最新の書き込みデータもしくはエラーのどちらかを受け取る性質。

可用性 (Availability)
: ノードの障害により生存ノードの機能性が損なわれない性質。単一障害点 (SPoF = Single Point of Failure) が存在しない。

分断耐性 (Partition-tolerance)
: システムは任意の通信障害などによるメッセージ損失に対し、継続して動作を行う性質。

## BASE 特性

BASE 特性とは前述の CAP 定理の制約の下、高可用性を達成するシステムの特性である。

- Basically Available (基本的に利用可能)
- Soft state, **Eventually consistent (結果整合性)**

結果整合性とは、厳密な一貫性は保証しないものの、時間経過で正しい状態に収束する性質のことである。

NoSQL に代表されるデータストアでは、結果整合性を採用することで、容易なスケールアウトを実現している。

## レプリケーション (replication, 複製)

レプリケーションとはリソース (ex. 分散データベースにおけるコミットログやデータ) の複製、あるいは複製する処理のことをいう。

### コピー内容による分類

論理レプリケーション (トランザクション・レプリケーション, 計算レプリケーション)
: トランザクションログのレプリケーション。
ログ構造化ファイルシステムは論理レプリケーションの 1 つである。

物理レプリケーション (データレプリケーション, 状態機械レプリケーション)
: 変更されたデータのレプリケーション。

### 書き込み操作をどう扱うかによる分類

同期レプリケーション
: ローカルストレージとリモートノードの両方から完了通知があるまで、書き込み要求が完了したとはみなさない。
そのため、全体の性能が低下する。
また、一部ノードに障害が発生している間の書き込み要求は全て失敗となるため、可用性は保証できない。

非同期レプリケーション
: ローカルストレージで書き込み完了すると同時に書き込み要求が完了したとみなす。
リモートノードのストレージ更新までには遅延があるため、一貫性は保証できない。

Quorum
: 要求が完了したとみなすために必要な最低限の票 (リモートノードからのコミット完了通知) の数。
前述の同期レプリケーションでは Quorum = リモートノードの数, 非同期レプリケーションでは Quorum = 0 とみなすことができる。

<!-- TODO Quorum ベース投票によるレプリケーション管理について書く -->

## パーティション

パーティション (シャード, shard) は分散システムにおけるデータの分割を指す。

テーブルの分割方法には以下の 2 種類がある。

水平分割
: 1 つのテーブルを**行単位**で複数のパーティションに分割する

垂直分割
: 1 つのテーブルを**列単位**で複数のパーティションに分割する

## アーキテクチャ

### シェアード・エブリシング (shared everything)

分散システムにおいて、各ノードが同じパーティションを共有するモデルを指す。

プライマリ/バックアップ (マスター/スレーブ)
: 古典的な分散システムの多くがこのモデルを採用している。
書き込み要求を司るプライマリノードと読み込み要求を司るバックアップノードに役割を分担する。
プライマリノードが何らかの障害で停止すると、バックアップノードが役割を交代して計算を引き継ぐ。(**フェイルオーバー**)
非同期レプリケーションではプライマリノードの障害発生のタイミングによってはログの一部が失われる。

マルチプライマリ (マルチマスター)
: 任意のノードに更新要求を送ることができ、そこから他のサーバーに通知する。
トランザクションがかち合うのを防ぐことが課題となり、非同期レプリケーションでは衝突を防ぐことはできないため、何らかの方法 (ex. 分散ロックマネージャ) で一貫性を保証しなければならない。

RAC (Real Application Clusters, シェアード・ディスク)
: Oracle RAC が採用している、各ノードが同じストレージを共有する構成。
ここでは詳しく解説しない。

### シェアード・ナッシング (shared nothing)

分散システムにおいて、各ノードが同じパーティションを共有しないモデルを指す。
いずれかのノードが何らかの障害で停止すると、そのノードに割当てられていたパーティションが読めなくなるため、分断耐性は保証できない。

シェアード・ナッシングでは、異なるパーティションに対する結合を含むような問い合わせにおいて、シェアード・エブリシングよりも処理時間がかかる。

データが属するパーティションを決定する (パーティショニング, partitioning) 方法には以下の 2 つがある。

コンシステントハッシュ法
: データの任意の部分 (ex. パーティションキー) にハッシュ関数を適用し、そのハッシュ値をパーティション数で割ったときの剰余によってパーティションを決定する。

アプリケーションパーティショニング
:  トランザクションが参照するパーティション数が最小になるよう、アプリケーションのユースケースの知識を含めて、アプリケーション側で最適なパーティションを決定する。
前述した「異なるパーティションに対する結合を含むような問い合わせ」というシェアード・ナッシングの弱点を解消する。

<!-- TODO アプリケーションパーティショニングについて書く -->
<!-- TODO ブルームフィルタについて書く -->
<!-- TODO Two Phase Commit について書く -->
<!-- TODO 分散メッセージングについて書く -->
<!-- TODO 基本的な用語の解説を書く -->

## 参考文献

- [グロッシュの法則](https://ja.wikipedia.org/wiki/%E3%82%B0%E3%83%AD%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E6%B3%95%E5%89%87)
- [分散コンピューティングの落とし穴](https://ja.wikipedia.org/wiki/%E5%88%86%E6%95%A3%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%AE%E8%90%BD%E3%81%A8%E3%81%97%E7%A9%B4)
- [透過性 (情報工学)](https://ja.wikipedia.org/wiki/%E9%80%8F%E9%81%8E%E6%80%A7_(%E6%83%85%E5%A0%B1%E5%B7%A5%E5%AD%A6))
- [分割 (データベース)](https://ja.wikipedia.org/wiki/%E5%88%86%E5%89%B2_(%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9))
- [レプリケーション](https://ja.wikipedia.org/wiki/%E3%83%AC%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)
- [Quorum](https://ja.wikipedia.org/wiki/Quorum)
- [シェアード・ナッシング・アーキテクチャ](https://ja.wikipedia.org/wiki/%E3%82%B7%E3%82%A7%E3%82%A2%E3%83%BC%E3%83%89%E3%83%BB%E3%83%8A%E3%83%83%E3%82%B7%E3%83%B3%E3%82%B0%E3%83%BB%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3)
- [コンシステントハッシュ法](https://ja.wikipedia.org/wiki/%E3%82%B3%E3%83%B3%E3%82%B7%E3%82%B9%E3%83%86%E3%83%B3%E3%83%88%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E6%B3%95)
