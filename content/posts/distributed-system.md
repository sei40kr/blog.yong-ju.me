---
title: "分散システム"
date: 2021-01-10T04:54:24+09:00
tags: ["勉強ノート", "分散システム", "データベース"]
---

## 前提知識

- [データベースシステム]({{< ref "database-system" >}})

## 分散システムの原則

分散システムは以下の原則を満たすことを期待する。

1. 分散が透過的であること
   - **位置に対する透過性**
   - **複製 (レプリケーション) に対する透過性**
   - **分割に対する透過性**
1. トランザクションが透過的であること

「透過的である」とは、ユーザー (ex. 分散データベースの場合はアプリケーション開発者) がそのシステムの技術的詳細を意識することなく使えることを意味する。

## 分散システムの落とし穴

- ネットワークは信頼できない。
- レイテンシはゼロではない。
- 帯域幅が存在する。
- トランスポートコストはゼロではない。

## アムダールの法則

**アムダールの法則**は、並列コンピューティングにおいて、並列度を上げた場合に並列化できない部分の存在がボトルネックになることを示すものである。
分散システム全体のスループットにおいても、ノード数を並列度として同じように考えることができる。

$P$
: プログラムの並列化できる部分の実行時間の割合

$N$
: 使用するプロセッサの個数 (分散システムではノード数)

としたとき、並列化による全体の性能向上率は次の式で表される。

$$=\frac{1}{(1-P)+\frac{P}{N}}$$

## CAP 定理

ノード間のデータ複製において、同時に次の 3 つの保証を提供できない。

一貫性 (Consistency)
: すべてのデータ読み込みにおいて、最新の書き込みデータもしくはエラーのどちらかを受け取る性質。

可用性 (Availability)
: ノードの障害により生存ノードの機能性が損なわれない性質。単一障害点 (SPoF = Single Point of Failure) が存在しない。

分断耐性 (Partition-tolerance)
: システムは任意の通信障害などによるメッセージ損失に対し、継続して動作を行う性質。

## BASE 特性

BASE 特性とは前述の CAP 定理の制約の下、高可用性を達成するシステムの特性である。

- Basically Available (基本的に利用可能)
- Soft state, **Eventually consistent (結果整合性)**

結果整合性とは、厳密な一貫性は保証しないものの、時間経過で正しい状態に収束する性質のことである。

NoSQL に代表されるデータストアでは、結果整合性を採用することで、容易なスケールアウトを実現している。

## レプリケーション (replication)

### コピー内容による分類

トランザクション・レプリケーション (計算レプリケーション, 論理レプリケーション)
: トランザクションログのレプリケーション。
**Log-Structured Storage** はトランザクション・レプリケーションを実現する方法の 1 つである。

状態機械レプリケーション (データレプリケーション, 物理レプリケーション)
: 変更されたデータのレプリケーション。

### 書き込み操作をどう扱うかによる分類

同期レプリケーション
: ローカルストレージとリモートノードの両方から完了通知があるまで、書き込み要求が完了したとはみなさない。
そのため、全体の性能が低下する。
また、一部ノードに障害が発生している間の書き込み要求は全て失敗となるため、可用性は保証できない。

非同期レプリケーション
: ローカルストレージで書き込み完了すると同時に書き込み要求が完了したとみなす。
リモートノードのストレージ更新までには遅延があるため、一貫性は保証できない。

Quorum
: 要求が完了したとみなすために必要な最低限の票 (リモートノードからのコミット完了通知) の数。
前述の同期レプリケーションでは Quorum = リモートノードの数, 非同期レプリケーションでは Quorum = 0 とみなすことができる。

<!-- TODO Quorum ベース投票によるレプリケーション管理について書く -->

## アーキテクチャ

### シェアード・エブリシング (shared everything)

分散システムにおいて、各ノードが同じリソースを共有するモデルを指す。

プライマリ/バックアップ
: 古典的な分散システムの多くがこのモデルを採用している。
書き込み要求を司るプライマリノードと読み込み要求を司るバックアップノードに役割を分担する。
プライマリノードが何らかの障害で停止すると、バックアップノードが役割を交代して計算を引き継ぐ。(**フェイルオーバー**)
非同期レプリケーションではプライマリノードの障害発生のタイミングによってはログの一部が失われる。

マルチプライマリ
: 任意のノードに更新要求を送ることができ、そこから他のサーバーに通知する。
トランザクションがかち合うのを防ぐことが課題となり、非同期レプリケーションでは衝突を防ぐことはできないため、何らかの方法 (ex. 分散ロックマネージャ) で一貫性を保証しなければならない。

RAC (Real Application Clusters, シェアード・ディスク)
: Oracle RAC が採用している、各ノードが同じストレージを共有する構成。
ここでは詳しく解説しない。

### シェアード・ナッシング (shared nothing)

分散システムにおいて、各ノードが同じリソースを共有しないモデルを指す。
異なるパーティション (後述) に対する結合を含むような問い合わせに対し、シェアード・エブリシング・モデルよりも処理時間がかかる。
一般的には、多数のノードにレプリケーションをもたせ、分断耐性を保証する。

パーティション (シャード, shard)
: 分散データベースにおけるデータの分割。

水平分割
: 1 つのテーブルを行単位で複数のパーティションに分割すること。

垂直分割
: 1 つのテーブルを列単位で複数のパーティションに分割すること。

コンシステント・ハッシュ法
: **パーティションキー (分割キー, partition key)** のハッシュ関数の値によって、どのパーティションに含めるかを決定する方法。

<!-- TODO アプリケーションパーティショニングについて書く -->
<!-- TODO ブルームフィルタについて書く -->
<!-- TODO Two Phase Commit について書く -->
<!-- TODO 分散メッセージングについて書く -->
<!-- TODO 基本的な用語の解説を書く -->
